<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>

    <!-- A-Frame + MindAR -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <!-- Poppins (for troika-text) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;700&display=swap" rel="stylesheet">
    <!-- Troika text for true webfonts in A-Frame (adds, doesnâ€™t replace) -->
    <script src="https://unpkg.com/troika-three-text@0.49.0/dist/troika-three-text.min.js"></script>
    <script src="https://unpkg.com/aframe-troika-text/dist/aframe-troika-text.min.js"></script>

    <style>
      html, body { margin:0; padding:0; height:100%; }
      .example-container { position:absolute; inset:0; overflow:hidden; }

      /* Vertical (portrait) scanning overlay for a vertical card */
      #example-scanning-overlay{
        display:flex; align-items:center; justify-content:center;
        position:absolute; inset:0; background:transparent; z-index:2;
        /* never block mouse/touch so icons are clickable behind it */
        pointer-events:none;
      }
      #example-scanning-overlay.hidden{ display:none; }
      #example-scanning-overlay .inner{
        position:relative; display:flex; align-items:center; justify-content:center;
        width:42vw; height:72vh; max-width:360px; max-height:720px;
        background:
          linear-gradient(to right, white 8px, transparent 8px) 0 0,
          linear-gradient(to right, white 8px, transparent 8px) 0 100%,
          linear-gradient(to left,  white 8px, transparent 8px) 100% 0,
          linear-gradient(to left,  white 8px, transparent 8px) 100% 100%,
          linear-gradient(to bottom, white 8px, transparent 8px) 0 0,
          linear-gradient(to bottom, white 8px, transparent 8px) 100% 0,
          linear-gradient(to top,    white 8px, transparent 8px) 0 100%,
          linear-gradient(to top,    white 8px, transparent 8px) 100% 100%;
        background-repeat:no-repeat; background-size:36px 36px;
        pointer-events:none;
      }
      #example-scanning-overlay .scanline{
        position:absolute; left:0; width:100%; height:8px; background:white; opacity:0.75;
        animation:scan 2s linear infinite;
        pointer-events:none;
      }
      @keyframes scan{ 0%,100%{ top:0% } 50%{ top:calc(100% - 8px) } }
    </style>

    <script>
      // Register component to sync video and (optional) external audio element
      AFRAME.registerComponent('play-video', {
        init: function() {
          // the <video> element backing the <a-video>
          const mat = this.el.getObject3D('mesh') && this.el.components.material && this.el.components.material.material;
          this.video = (mat && mat.map && mat.map.image) || document.getElementById('right-video');

          // If you keep a separate <audio>, you can sync it here (optional)
          this.audio = document.getElementById('video-audio'); // may not exist; safe to ignore

          if (!this.video) return;

          this.video.addEventListener('play', () => {
            if (this.audio && this.audio.paused) {
              this.audio.currentTime = this.video.currentTime;
              this.audio.play().catch(()=>{});
            }
          });
          this.video.addEventListener('pause', () => { if (this.audio) this.audio.pause(); });
          this.video.addEventListener('seeked', () => {
            if (this.audio && !this.audio.paused) this.audio.currentTime = this.video.currentTime;
          });
        }
      });

      // Simple link-opener that works with A-Frame cursor/raycaster
      AFRAME.registerComponent('open-link', {
        schema: { url: {type: 'string'}, newTab: {type: 'boolean', default: true} },
        init() {
          this.onClick = () => {
            if (!this.data.url) return;
            try {
              // open in same tab improves reliability on mobile
              this.data.newTab ? window.open(this.data.url, '_blank') : (window.location.href = this.data.url);
            } catch(e) { console.warn('open-link blocked:', e); }
          };
          this.el.addEventListener('click', this.onClick);
        },
        remove() { this.el.removeEventListener('click', this.onClick); }
      });

      // User-gesture audio unlocker for Chrome/iOS
      AFRAME.registerComponent('unmute-audio', {
        init() {
          const resumeAudio = async () => {
            try {
              const AC = window.AudioContext || window.webkitAudioContext;
              const ctx = AFRAME.audioContext || (AFRAME.audioContext = new AC());
              if (ctx && ctx.state !== 'running' && ctx.resume) await ctx.resume();
            } catch(e) {}
          };
          this.onClick = async () => {
            await resumeAudio();

            // Unmute the asset video and play with sound
            const v = document.getElementById('right-video');
            if (v) {
              try {
                v.muted = false;
                v.play().catch(()=>{});
              } catch(e) {}
            }
            // hide button
            this.el.setAttribute('visible', false);
          };
          this.el.addEventListener('click', this.onClick);
        },
        remove(){ this.el.removeEventListener('click', this.onClick); }
      });

      // Reveal/Hide helpers (unchanged)
      function reveal(ids){
        ids.forEach(id=>{
          const el = document.querySelector(id);
          if(!el) return;
          el.setAttribute('visible', true);
          el.emit('show');
          el.querySelectorAll('*').forEach(child=>{
            if (child.emit) child.emit('show');
          });
        });
      }
      function conceal(ids){
        ids.forEach(id=>{
          const el = document.querySelector(id);
          if(!el) return;
          el.setAttribute('visible', false);
        });
      }
      const openNew = (url)=> window.open(url, '_blank');

      AFRAME.registerComponent('mytarget', {
        init: function (){
          const el = this.el;

          // MindAR events-handling style: also bind direct listeners (belt & suspenders)
          const bindings = [
            ['#icon-insta-hit','https://instagram.com/'],
            ['#icon-linkedin-hit','https://www.linkedin.com/'],
            ['#icon-discord-hit','https://discord.com/invite/'],
            ['#icon-whatsapp-hit','https://wa.me/']
          ];
          bindings.forEach(([sel,url])=>{
            const node = document.querySelector(sel);
            if (node) {
              node.setAttribute('open-link', `url: ${url}; newTab: false`);
              node.addEventListener('click', ()=> { window.location.href = url; });
            }
          });

          el.addEventListener('targetFound', ()=>{
            reveal(['#icons-group','#rightcol-group','#model-group']);
            const vid = document.querySelector('#right-video');
            if(vid) { vid.play().catch(()=>{}); }
            const th = document.querySelector('#troika-heading');
            const ts = document.querySelector('#troika-subtitle');
            if (th) th.emit('show');
            if (ts) ts.emit('show');
          });
          el.addEventListener('targetLost', ()=>{
            conceal(['#icons-group','#rightcol-group','#model-group']);
            const vid = document.querySelector('#right-video');
            if(vid) vid.pause();
          });
        }
      });

      // Configurable GLB scale & rotation
      const MODEL_SCALE = {x: 1, y: 1, z: 1};
      const MODEL_ROTATION = {x: 45, y: -50, z:40};
      const SPIN_DURATION = 12000; // ms for full rotation

      document.addEventListener("DOMContentLoaded", ()=>{
        const model = document.querySelector("#mini-model");
        if(model){
          model.setAttribute("scale", `${MODEL_SCALE.x} ${MODEL_SCALE.y} ${MODEL_SCALE.z}`);
          model.setAttribute("rotation", `${MODEL_ROTATION.x} ${MODEL_ROTATION.y} ${MODEL_ROTATION.z}`);
          model.setAttribute("animation__spin",
            `property: rotation; to: 0 360 0; loop: true; dur: ${SPIN_DURATION}; easing: linear`);
        }
      });
    </script>
  </head>

  <body>
    <div class="example-container">
      <!-- Portrait scanner frame -->
      <div id="example-scanning-overlay" class="hidden">
        <div class="inner"><div class="scanline"></div></div>
      </div>

      <!-- Keep your working MindAR smoothing values -->
      <a-scene
        mindar-image="imageTargetSrc: ./assets/targets.mind; showStats: false; uiScanning: #example-scanning-overlay; filterMinCF: 0.3; filterBeta: 0.001; warmupTolerance: 5; missTolerance: 8;"
        embedded
        color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights, antialias: true"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false">

        <!-- Mouse ray for clicking (MindAR pattern: cursor + raycaster on camera) -->
        <a-camera position="0 0 0"
                  look-controls="enabled: false"
                  cursor="fuse: false; rayOrigin: mouse;"
                  raycaster="near: 0.001; far: 10000; interval: 0; objects: .clickable">
        </a-camera>

        <!-- Assets: white PNG icons + video + your GLB -->
        <a-assets>
          <!-- White icons (reliable PNGs) -->
          <img id="igw" crossorigin="anonymous" src="https://img.icons8.com/ios-filled/100/FFFFFF/instagram-new.png">
          <img id="liw" crossorigin="anonymous" src="https://img.icons8.com/ios-filled/100/FFFFFF/linkedin.png">
          <img id="dcw" crossorigin="anonymous" src="https://img.icons8.com/ios-filled/100/FFFFFF/discord-logo.png">
          <img id="waw" crossorigin="anonymous" src="https://img.icons8.com/ios-filled/100/FFFFFF/whatsapp.png">

          <!-- Rounded card texture (SVG data URI) used as button background -->
          <img id="rounded-card" crossorigin="anonymous"
               src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='400' height='260' viewBox='0 0 400 260'><rect x='2' y='2' width='396' height='256' rx='36' ry='36' fill='white' fill-opacity='0.08' stroke='white' stroke-opacity='0.6' stroke-width='4'/></svg>">

          <!-- Right-side video (NOTE: autoplay muted; unmute via the in-scene button) -->
          <video id="right-video"
                 src="./assets/right2test.mp4"
                 crossorigin="anonymous"
                 preload="auto"
                 autoplay
                 loop
                 playsinline
                 webkit-playsinline></video>

          <!-- Your GLB -->
          <a-asset-item id="userModel" src="./assets/light_bulb.glb" crossorigin="anonymous"></a-asset-item>
        </a-assets>

        <!-- Lights -->
        <a-entity light="type: ambient; intensity: 1.0"></a-entity>
        <a-entity light="type: directional; intensity: 0.9" position="1 2 1"></a-entity>

        <!-- Anchor to first target -->
        <a-entity id="mytarget" mytarget mindar-image-target="targetIndex: 0">

          <!-- 1) ICONS (added rounded backgrounds + large hit areas that open links) -->
          <a-entity id="icons-group" visible="false" position="0 -1.30 0.001"
                    animation__fade="property: scale; from: 0 0 0; to: 1 1 1; dur: 700; easing: easeOutCubic; startEvents: show">

            <!-- Instagram button bg + hit -->
            <a-plane src="#rounded-card" position="-0.60 0 -0.01" width="0.36" height="0.24"
                     material="shader: flat; transparent: true; alphaTest: 0.01"></a-plane>
            <a-plane id="icon-insta-hit" class="clickable" position="-0.60 0 0.01" width="0.36" height="0.24"
                     color="#fff" opacity="0.001"></a-plane>

            <!-- LinkedIn button bg + hit -->
            <a-plane src="#rounded-card" position="-0.20 0 -0.01" width="0.36" height="0.24"
                     material="shader: flat; transparent: true; alphaTest: 0.01"></a-plane>
            <a-plane id="icon-linkedin-hit" class="clickable" position="-0.20 0 0.01" width="0.36" height="0.24"
                     color="#fff" opacity="0.001"></a-plane>

            <!-- Discord button bg + hit -->
            <a-plane src="#rounded-card" position="0.20 0 -0.01" width="0.36" height="0.24"
                     material="shader: flat; transparent: true; alphaTest: 0.01"></a-plane>
            <a-plane id="icon-discord-hit" class="clickable" position="0.20 0 0.01" width="0.36" height="0.24"
                     color="#fff" opacity="0.001"></a-plane>

            <!-- WhatsApp button bg + hit -->
            <a-plane src="#rounded-card" position="0.60 0 -0.01" width="0.36" height="0.24"
                     material="shader: flat; transparent: true; alphaTest: 0.01"></a-plane>
            <a-plane id="icon-whatsapp-hit" class="clickable" position="0.60 0 0.01" width="0.36" height="0.24"
                     color="#fff" opacity="0.001"></a-plane>

            <!-- Original icons (unchanged), layered above backgrounds -->
            <a-image id="icon-insta" class="clickable"
                     src="#igw" scale="1.4 1.4 1"
                     position="-0.60 0 0.02" width="0.16" height="0.16" opacity="0.95">
            </a-image>

            <a-image id="icon-linkedin" class="clickable"
                     src="#liw" scale="1.4 1.4 1"
                     position="-0.20 0 0.02" width="0.16" height="0.16" opacity="0.95">
            </a-image>

            <a-image id="icon-discord" class="clickable"
                     src="#dcw" scale="1.4 1.4 1"
                     position="0.20 0 0.02" width="0.16" height="0.16" opacity="0.95">
            </a-image>

            <a-image id="icon-whatsapp" class="clickable"
                     src="#waw" scale="1.4 1.4 1"
                     position="0.60 0 0.02" width="0.16" height="0.16" opacity="0.95">
            </a-image>
          </a-entity>

          <!-- 2) RIGHT COLUMN -->
          <a-entity id="rightcol-group" visible="false" position="0.30 0 -0.02"
                    animation__fade="property: scale; from: 0.9 0.9 0.9; to: 1 1 1; dur: 600; easing: easeOutCubic; startEvents: show">

            <!-- 16:9 Video with audio support -->
            <a-video id="right-video-entity"
                     src="#right-video"
                     position="1.2 0.45 0"
                     width="1.60"
                     height="0.90"
                     material="shader: flat; src: #right-video; transparent: true; opacity: 0;"
                     animation__in="property: material.opacity; from: 0; to: 1; dur: 600; easing: easeOutCubic; startEvents: show"
                     play-video>
            </a-video>

            <!-- Tap for audio button (click to unmute video + resume audio context) -->

            <!-- Your original A-Frame texts (kept intact) -->
            <a-text id="heading"
                    value="Making Ideas like this Happen, but how?"
                    color="#FFFFFF"
                    align="left"
                    width="1.8"
                    position="0.4  -0.3 0"
                    anchor="left"
                    opacity="0"
                    letter-spacing="2"
                    wrap-count="20"
                    animation__in="property: opacity; from: 0; to: 1; dur: 600; delay: 120; easing: easeOutCubic; startEvents: show">
            </a-text>

            <a-text id="subtitle"
                    value="Follow us on social media to know more!"
                    color="#EEEEEE"
                    align="left"
                    width="1.8"
                    position="0.4  -0.725 0"

                    anchor="left"
                    opacity="0"
                    wrap-count="24"
                    animation__in="property: opacity; from: 0; to: 1; dur: 600; delay: 240; easing: easeOutCubic; startEvents: show">
            </a-text>

            <!-- Troika text using Poppins (added; originals preserved) -->
            <a-entity id="troika-heading"
                      troika-text="value: Making Ideas like this Happen, but how?;
                                   anchor: left; maxWidth: 1.6; color: #FFFFFF; fontSize: 0.07;
                                   font: https://fonts.gstatic.com/s/poppins/v20/pxiByp8kv8JHgFVrLEj6Z1xlFQ.woff2;"
                      position="0 -0.40 0"
                      visible="true"
                      opacity="0"
                      animation__in="property: opacity; from: 0; to: 1; dur: 600; delay: 100; easing: easeOutCubic; startEvents: show">
            </a-entity>

            <a-entity id="troika-subtitle"
                      troika-text="value: Click on the icons to learn more about us!;
                                   anchor: left; maxWidth: 1.6; color: #DDDDDD; fontSize: 0.055;
                                   font: https://fonts.gstatic.com/s/poppins/v20/pxiEyp8kv8JHgFVrJJLucXtAKPY.woff2;"
                      position="0 -0.90 0"
                      visible="true"
                      opacity="0"
                      animation__in="property: opacity; from: 0; to: 1; dur: 600; delay: 220; easing: easeOutCubic; startEvents: show">
            </a-entity>
          </a-entity>

          <!-- 3) 3D MODEL (pushed further right & down for maximum separation) -->
          <a-entity id="model-group" visible="false" position="2.00 -1.50 -0.03"
                    animation__fade="property: scale; from: 0 0 0; to: 1 1 1; dur: 800; easing: easeOutCubic; startEvents: show">
            <a-gltf-model id="mini-model"
                          src="#userModel"
                          position="0 0 0"
                          scale="0.28 0.28 0.28"
                          rotation="0 0 0">
            </a-gltf-model>
          </a-entity>

        </a-entity>
      </a-scene>
    </div>
  </body>
</html>
